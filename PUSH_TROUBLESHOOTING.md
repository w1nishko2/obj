# Решение проблем с Push-уведомлениями

## Ошибка 499: Антивирус блокирует Service Worker

**Причина:** Антивирус (Kaspersky, Avast, AVG и др.) блокирует `service-worker.js`

**Решение:**
1. Откройте настройки антивируса
2. Добавьте исключение для:
   - `C:\ospanel\domains\work\public\service-worker.js`
   - Или весь домен `work` (localhost)
3. Перезагрузите страницу

**Альтернатива:** Временно отключите веб-защиту антивируса для тестирования

---

## Уведомления заблокированы (permission: denied)

**Причина:** Вы ранее отклонили запрос на уведомления

**Решение в Chrome:**
1. Кликните на иконку **замка** слева от адреса сайта (в адресной строке)
2. Найдите **"Уведомления"**
3. Выберите **"Разрешить"** вместо "Блокировать"
4. Обновите страницу (`F5`)

**Решение в Yandex Browser:**
1. Кликните на **три полоски** → Настройки
2. Сайты → Расширенные настройки сайтов
3. Уведомления → Разрешенные
4. Добавьте `https://work` или найдите и разблокируйте

**Сброс всех разрешений:**
1. `F12` → Application → Storage → **Clear site data**
2. Обновите страницу (`Ctrl+F5`)

---

## Модалка висит на "Подключение..."

**Причина:** Service Worker не регистрируется или разрешение отклонено

**Решение:**
1. Откройте консоль браузера (`F12` → Console)
2. Посмотрите ошибки:
   - `499` → антивирус блокирует
   - `permission: denied` → разрешение заблокировано
3. Следуйте инструкциям выше

---

## Проверка работоспособности

### 1. Проверьте разрешения в браузере
```javascript
// Откройте консоль (F12) и выполните:
console.log('Notification permission:', Notification.permission);
// Должно быть: "granted" (разрешено)
```

### 2. Проверьте Service Worker
```javascript
// В консоли:
navigator.serviceWorker.ready.then(reg => console.log('SW готов:', reg));
```

### 3. Проверьте подписку в базе
```bash
php check_subs.php
```

Должно показать ваш User ID и имя.

---

## Пошаговая настройка с нуля

### Шаг 1: Очистка
```javascript
// F12 → Console
localStorage.clear();
location.reload();
```

### Шаг 2: Сброс разрешений
1. `F12` → Application → Storage → **Clear site data**
2. Кликните на замок в адресной строке → **Сбросить разрешения**

### Шаг 3: Отключите антивирус
Временно отключите веб-защиту или добавьте исключение

### Шаг 4: Обновите страницу
`Ctrl+F5`

### Шаг 5: Разрешите уведомления
1. Дождитесь модалку (2 секунды)
2. Нажмите **"Включить"**
3. В диалоге браузера нажмите **"Разрешить"**

### Шаг 6: Проверка
```bash
php check_subs.php
```

---

## Типичные ошибки

### "Service Worker не регистрируется"
- Проверьте антивирус
- Проверьте что файл `public/service-worker.js` существует
- Проверьте что сайт работает по HTTPS (или localhost)

### "User ID пустой в подписках"
- Проверьте что пользователь авторизован
- Проверьте маршруты в `routes/web.php` (должны быть внутри `auth` middleware)

### "No push subscriptions found"
- Пользователь не подписался
- Подписка создалась с `user_id = NULL` (исправлено)
- Запустите `php check_subs.php` для проверки

---

## Контакты для помощи

Если проблемы остались:
1. Откройте консоль (`F12`)
2. Скопируйте все ошибки
3. Проверьте логи Laravel: `storage/logs/laravel.log`
