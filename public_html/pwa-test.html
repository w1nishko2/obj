<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Тестирование - Объект+</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <style>
        body {
            padding: 20px;
            background: #f8f9fa;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">
            <i class="bi bi-gear-fill"></i>
            Тестирование PWA
        </h1>

        <!-- Проверка Service Worker -->
        <div class="test-card">
            <h3>Service Worker</h3>
            <div id="sw-status">Проверка...</div>
            <div id="sw-details" class="mt-3"></div>
        </div>

        <!-- Проверка манифеста -->
        <div class="test-card">
            <h3>Манифест</h3>
            <div id="manifest-status">Проверка...</div>
            <div id="manifest-details" class="mt-3"></div>
        </div>

        <!-- Проверка установки -->
        <div class="test-card">
            <h3>Возможность установки</h3>
            <div id="install-status">Проверка...</div>
            <button id="install-btn" class="btn btn-primary mt-3" style="display:none;">
                Установить приложение
            </button>
        </div>

        <!-- Информация об устройстве -->
        <div class="test-card">
            <h3>Информация об устройстве</h3>
            <div id="device-info"></div>
        </div>

        <!-- Проверка кеша -->
        <div class="test-card">
            <h3>Кеш</h3>
            <div id="cache-info">Проверка...</div>
            <button id="clear-cache-btn" class="btn btn-warning mt-3">
                Очистить кеш
            </button>
        </div>

        <!-- Проверка онлайн/офлайн -->
        <div class="test-card">
            <h3>Статус соединения</h3>
            <div id="online-status"></div>
        </div>
    </div>

    <script>
        // Проверка Service Worker
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            const detailsDiv = document.getElementById('sw-details');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        statusDiv.innerHTML = '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> Активен</span>';
                        detailsDiv.innerHTML = `
                            <p><strong>Scope:</strong> ${registration.scope}</p>
                            <p><strong>State:</strong> ${registration.active ? registration.active.state : 'нет'}</p>
                            <p><strong>URL:</strong> ${registration.active ? registration.active.scriptURL : 'нет'}</p>
                        `;
                    } else {
                        statusDiv.innerHTML = '<span class="status-badge status-warning"><i class="bi bi-exclamation-triangle-fill"></i> Не зарегистрирован</span>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<span class="status-badge status-error"><i class="bi bi-x-circle-fill"></i> Ошибка</span>';
                    detailsDiv.innerHTML = `<p class="text-danger">${error.message}</p>`;
                }
            } else {
                statusDiv.innerHTML = '<span class="status-badge status-error"><i class="bi bi-x-circle-fill"></i> Не поддерживается</span>';
            }
        }

        // Проверка манифеста
        async function checkManifest() {
            const statusDiv = document.getElementById('manifest-status');
            const detailsDiv = document.getElementById('manifest-details');
            
            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();
                statusDiv.innerHTML = '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> Загружен</span>';
                detailsDiv.innerHTML = `
                    <p><strong>Название:</strong> ${manifest.name}</p>
                    <p><strong>Короткое название:</strong> ${manifest.short_name}</p>
                    <p><strong>Режим отображения:</strong> ${manifest.display}</p>
                    <p><strong>Цвет темы:</strong> <span style="background:${manifest.theme_color};padding:2px 8px;color:white;border-radius:4px;">${manifest.theme_color}</span></p>
                    <p><strong>Иконок:</strong> ${manifest.icons.length}</p>
                `;
            } catch (error) {
                statusDiv.innerHTML = '<span class="status-badge status-error"><i class="bi bi-x-circle-fill"></i> Ошибка загрузки</span>';
                detailsDiv.innerHTML = `<p class="text-danger">${error.message}</p>`;
            }
        }

        // Проверка возможности установки
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-status').innerHTML = '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> Можно установить</span>';
            document.getElementById('install-btn').style.display = 'block';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                document.getElementById('install-status').innerHTML = outcome === 'accepted' 
                    ? '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> Установлено</span>'
                    : '<span class="status-badge status-info"><i class="bi bi-info-circle-fill"></i> Отклонено</span>';
                deferredPrompt = null;
                document.getElementById('install-btn').style.display = 'none';
            }
        });

        // Информация об устройстве
        function checkDevice() {
            const deviceDiv = document.getElementById('device-info');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            deviceDiv.innerHTML = `
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Платформа:</strong> ${navigator.platform}</p>
                <p><strong>iOS:</strong> ${isIOS ? '✅ Да' : '❌ Нет'}</p>
                <p><strong>Android:</strong> ${isAndroid ? '✅ Да' : '❌ Нет'}</p>
                <p><strong>Standalone режим:</strong> ${isStandalone ? '✅ Да (установлено)' : '❌ Нет'}</p>
                <p><strong>Язык:</strong> ${navigator.language}</p>
            `;
        }

        // Проверка кеша
        async function checkCache() {
            const cacheDiv = document.getElementById('cache-info');
            
            try {
                const cacheNames = await caches.keys();
                cacheDiv.innerHTML = `
                    <p><strong>Кешей найдено:</strong> ${cacheNames.length}</p>
                    <ul>${cacheNames.map(name => `<li>${name}</li>`).join('')}</ul>
                `;
                
                if (cacheNames.length > 0) {
                    const cache = await caches.open(cacheNames[0]);
                    const cachedRequests = await cache.keys();
                    cacheDiv.innerHTML += `<p><strong>Закешировано файлов:</strong> ${cachedRequests.length}</p>`;
                }
            } catch (error) {
                cacheDiv.innerHTML = `<p class="text-danger">Ошибка: ${error.message}</p>`;
            }
        }

        document.getElementById('clear-cache-btn').addEventListener('click', async () => {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            alert('Кеш очищен! Перезагрузите страницу.');
            location.reload();
        });

        // Проверка онлайн/офлайн
        function checkOnlineStatus() {
            const statusDiv = document.getElementById('online-status');
            const updateStatus = () => {
                statusDiv.innerHTML = navigator.onLine 
                    ? '<span class="status-badge status-success"><i class="bi bi-wifi"></i> Онлайн</span>'
                    : '<span class="status-badge status-warning"><i class="bi bi-wifi-off"></i> Офлайн</span>';
            };
            updateStatus();
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
        }

        // Запуск всех проверок
        checkServiceWorker();
        checkManifest();
        checkDevice();
        checkCache();
        checkOnlineStatus();

        // Проверка установки через 1 секунду
        setTimeout(() => {
            if (!deferredPrompt) {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                document.getElementById('install-status').innerHTML = isStandalone
                    ? '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> Уже установлено</span>'
                    : '<span class="status-badge status-info"><i class="bi bi-info-circle-fill"></i> Событие не получено (возможно уже установлено или не поддерживается)</span>';
            }
        }, 1000);
    </script>
</body>
</html>
